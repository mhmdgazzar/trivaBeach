---
import Layout from "../layouts/Layout.astro";
---

<Layout title="TrivaBeach - Find Warm Water Swimming">
  <main class="min-h-screen bg-base-100">
    <!-- Hero Section -->
    <header class="relative overflow-hidden">
      <div
        class="absolute inset-0 bg-gradient-to-br from-primary/20 via-secondary/10 to-transparent"
      >
      </div>
      <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- GitHub link top right -->
        <a
          href="https://github.com/mhmdgazzar/trivaBeach"
          target="_blank"
          class="absolute top-4 right-4 btn btn-ghost btn-circle text-2xl hover:text-primary"
          title="View on GitHub"
        >
          <i class="ph-duotone ph-github-logo"></i>
        </a>
        <div class="flex items-center gap-3 mb-2">
          <img src="/trivaBeach.png" alt="TrivaBeach" class="h-36 md:h-48" />
        </div>
        <p class="text-base-content/70 text-lg">
          Find the nearest beaches with warm water (26¬∞C+) and book your stay
          based on the <a
            href="https://mcp.trivago.com/docs"
            target="_blank"
            class="link link-primary">TRIVAGO MCP Server</a
          >
        </p>
      </div>
    </header>

    <!-- Search Controls -->
    <section class="container mx-auto px-4 py-6">
      <div class="card bg-base-200/50 backdrop-blur-sm border border-base-300">
        <div class="card-body p-4 md:p-6">
          <div class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-1 w-full">
              <label class="label">
                <span class="label-text flex items-center gap-2">
                  <i class="ph-duotone ph-map-pin text-primary"></i>
                  Your Location
                </span>
              </label>
              <input
                type="text"
                id="location-input"
                placeholder="Click 'Use My Location' or enter coordinates"
                class="input input-bordered w-full bg-base-100"
                readonly
              />
            </div>
            <button id="geolocate-btn" class="btn btn-secondary gap-2">
              <i class="ph-duotone ph-crosshair"></i>
              Use My Location
            </button>
            <button id="search-btn" class="btn btn-primary gap-2" disabled>
              <i class="ph-duotone ph-magnifying-glass"></i>
              Find Warm Beaches
            </button>
          </div>

          <div id="status-message" class="mt-4 hidden">
            <div class="alert">
              <i class="ph-duotone ph-info text-xl"></i>
              <span id="status-text"></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Map Section -->
    <section class="container mx-auto px-4 py-4">
      <div
        class="card bg-base-200/50 backdrop-blur-sm border border-base-300 overflow-hidden"
      >
        <div id="map" class="h-[400px] w-full"></div>
      </div>
    </section>

    <!-- Results Section -->
    <section id="results-section" class="container mx-auto px-4 py-6 hidden">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="ph-duotone ph-sun text-accent"></i>
        Warm Water Beaches Near You
      </h2>
      <div id="results-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      </div>
    </section>

    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-base-100/80 backdrop-blur-sm z-50 flex items-center justify-center hidden"
    >
      <div class="text-center">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="mt-4 text-lg" id="loading-text">
          Searching for warm beaches...
        </p>
      </div>
    </div>
  </main>
</Layout>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

<script>
  const API_BASE = "https://api.trivabeach.gazzar.de";
  const OVERPASS_API = "https://overpass-api.de/api/interpreter";
  const MARINE_API = "https://marine-api.open-meteo.com/v1/marine";
  const MIN_WATER_TEMP = 26;

  // Known warm-water beach regions (year-round 26¬∞C+)
  const WARM_REGIONS = [
    { name: "Phuket, Thailand", lat: 7.9519, lng: 98.3381 },
    { name: "Bali, Indonesia", lat: -8.4095, lng: 115.1889 },
    { name: "Maldives", lat: 4.1755, lng: 73.5093 },
    { name: "Cancun, Mexico", lat: 21.1619, lng: -86.8515 },
    { name: "Punta Cana, DR", lat: 18.5601, lng: -68.3725 },
    { name: "Zanzibar, Tanzania", lat: -6.1659, lng: 39.2026 },
    { name: "Seychelles", lat: -4.6796, lng: 55.492 },
    { name: "Mauritius", lat: -20.3484, lng: 57.5522 },
    { name: "Goa, India", lat: 15.2993, lng: 74.124 },
    { name: "Dubai, UAE", lat: 25.2048, lng: 55.2708 },
    { name: "Hurghada, Egypt", lat: 27.2579, lng: 33.8116 },
    { name: "Tenerife, Spain", lat: 28.2916, lng: -16.6291 },
  ];

  let userLat = null;
  let userLng = null;
  let map = null;
  let markers = [];

  const locationInput = document.getElementById("location-input");
  const geolocateBtn = document.getElementById("geolocate-btn");
  const searchBtn = document.getElementById("search-btn");
  const statusMessage = document.getElementById("status-message");
  const statusText = document.getElementById("status-text");
  const resultsSection = document.getElementById("results-section");
  const resultsContainer = document.getElementById("results-container");
  const loadingOverlay = document.getElementById("loading-overlay");
  const loadingText = document.getElementById("loading-text");

  function initMap() {
    map = L.map("map").setView([20, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);
  }

  function showStatus(message, type = "info") {
    statusMessage.classList.remove("hidden");
    statusMessage.querySelector(".alert").className = `alert alert-${type}`;
    statusText.textContent = message;
  }

  function setLoading(show, text) {
    loadingOverlay.classList.toggle("hidden", !show);
    if (text) loadingText.textContent = text;
  }

  geolocateBtn.addEventListener("click", () => {
    if (!navigator.geolocation) {
      showStatus("Geolocation is not supported by your browser", "error");
      return;
    }

    geolocateBtn.classList.add("loading");
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLat = position.coords.latitude;
        userLng = position.coords.longitude;
        locationInput.value = `${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
        searchBtn.disabled = false;
        geolocateBtn.classList.remove("loading");
        showStatus(
          'Location detected! Click "Find Warm Beaches" to search.',
          "success",
        );

        if (map) {
          map.setView([userLat, userLng], 4);
          L.marker([userLat, userLng])
            .addTo(map)
            .bindPopup("üìç You are here")
            .openPopup();
        }
      },
      (error) => {
        geolocateBtn.classList.remove("loading");
        showStatus(`Error: ${error.message}`, "error");
      },
    );
  });

  async function findBeachesInRegion(lat, lng) {
    const query = `[out:json][timeout:25];node["natural"="beach"](around:50000,${lat},${lng});out body 5;`;
    try {
      const response = await fetch(OVERPASS_API, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `data=${encodeURIComponent(query)}`,
      });
      const data = await response.json();
      return data.elements || [];
    } catch {
      return [];
    }
  }

  async function getWaterTemp(lat, lng) {
    try {
      const url = `${MARINE_API}?latitude=${lat}&longitude=${lng}&current=sea_surface_temperature&cell_selection=sea`;
      const response = await fetch(url);
      const data = await response.json();
      return data.current?.sea_surface_temperature ?? null;
    } catch {
      return null;
    }
  }

  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371;
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLng = ((lng2 - lng1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLng / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function getHotels(lat, lng) {
    try {
      const arrival = new Date();
      arrival.setDate(arrival.getDate() + 7);
      const departure = new Date(arrival);
      departure.setDate(departure.getDate() + 7);

      const response = await fetch(`${API_BASE}/hotels`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          lat,
          lng,
          arrival: arrival.toISOString().split("T")[0],
          departure: departure.toISOString().split("T")[0],
          adults: 2,
          rooms: 1,
        }),
      });

      if (!response.ok) throw new Error("Failed to fetch hotels");
      return await response.json();
    } catch (error) {
      console.error("Error fetching hotels:", error);
      return [];
    }
  }

  function createBeachCard(beach, hotels) {
    return `
      <div class="card bg-base-200 border border-base-300 overflow-hidden">
        <div class="card-body p-4">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="card-title text-lg">
                <i class="ph-duotone ph-umbrella-simple text-primary"></i>
                ${beach.name}
              </h3>
              <p class="text-sm text-base-content/70">${beach.region} ‚Ä¢ ${beach.distance.toFixed(0)} km</p>
            </div>
            <div class="badge badge-primary badge-lg gap-1">
              <i class="ph-duotone ph-thermometer-hot"></i>
              ${beach.waterTemp}¬∞C
            </div>
          </div>
          
          <div class="divider my-2"></div>
          
          <h4 class="font-semibold flex items-center gap-2 mb-2">
            <i class="ph-duotone ph-bed text-secondary"></i>
            Nearby Hotels
          </h4>
          
          ${
            hotels.length > 0
              ? hotels
                  .map(
                    (hotel) => `
            <div class="bg-base-100 rounded-lg p-3 mb-2 last:mb-0">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium">${hotel.name}</p>
                  <div class="flex items-center gap-2 text-sm text-base-content/70">
                    <span class="flex items-center gap-1">
                      <i class="ph-fill ph-star text-accent"></i>
                      ${hotel.rating || "N/A"}
                    </span>
                    <span>‚Ä¢</span>
                    <span>${hotel.stars || "?"}‚òÖ Hotel</span>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-lg font-bold text-primary">${hotel.pricePerNight}</p>
                  <p class="text-xs text-base-content/60">/night</p>
                </div>
              </div>
              ${
                hotel.url
                  ? `<a href="${hotel.url}" target="_blank" class="btn btn-sm btn-outline btn-primary mt-2 gap-1">
                <i class="ph-duotone ph-arrow-square-out"></i>
                View on Trivago
              </a>`
                  : ""
              }
            </div>
          `,
                  )
                  .join("")
              : `
            <div class="text-center py-4 text-base-content/60">
              <i class="ph-duotone ph-magnifying-glass text-2xl mb-2"></i>
              <p>No hotels found nearby</p>
            </div>
          `
          }
        </div>
      </div>
    `;
  }

  searchBtn.addEventListener("click", async () => {
    if (!userLat || !userLng) return;

    setLoading(true, "Searching warm-water destinations worldwide...");
    markers.forEach((m) => m.remove());
    markers = [];

    try {
      // Sort warm regions by distance from user
      const regionsWithDistance = WARM_REGIONS.map((r) => ({
        ...r,
        distance: calculateDistance(userLat, userLng, r.lat, r.lng),
      })).sort((a, b) => a.distance - b.distance);

      setLoading(true, "Checking water temperatures in tropical regions...");

      const warmBeaches = [];

      for (const region of regionsWithDistance) {
        if (warmBeaches.length >= 2) break;

        setLoading(true, `Checking ${region.name}...`);

        const temp = await getWaterTemp(region.lat, region.lng);
        if (temp === null || temp < MIN_WATER_TEMP) continue;

        const beaches = await findBeachesInRegion(region.lat, region.lng);

        if (beaches.length > 0) {
          const beach = beaches[0];
          warmBeaches.push({
            id: beach.id,
            name: beach.tags?.name || region.name + " Beach",
            lat: beach.lat,
            lng: beach.lon,
            waterTemp: Math.round(temp),
            distance: region.distance,
            region: region.name,
          });
        } else {
          warmBeaches.push({
            id: `region-${region.name}`,
            name: region.name + " Beach",
            lat: region.lat,
            lng: region.lng,
            waterTemp: Math.round(temp),
            distance: region.distance,
            region: region.name,
          });
        }
      }

      if (warmBeaches.length === 0) {
        setLoading(false);
        showStatus(
          "Could not find beaches with warm water. Please try again later.",
          "warning",
        );
        return;
      }

      setLoading(true, "Finding hotels near beaches...");

      const results = [];
      for (const beach of warmBeaches.slice(0, 2)) {
        const hotels = await getHotels(beach.lat, beach.lng);
        results.push({ beach, hotels: hotels.slice(0, 2) });

        const marker = L.marker([beach.lat, beach.lng])
          .addTo(map)
          .bindPopup(`üèñÔ∏è ${beach.name}<br>üå°Ô∏è ${beach.waterTemp}¬∞C`);
        markers.push(marker);
      }

      resultsContainer.innerHTML = results
        .map((r) => createBeachCard(r.beach, r.hotels))
        .join("");
      resultsSection.classList.remove("hidden");

      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }

      setLoading(false);
      showStatus(
        `Found ${results.length} warm water beach destinations!`,
        "success",
      );
    } catch (error) {
      setLoading(false);
      showStatus(`Error: ${error.message || "Unknown error"}`, "error");
    }
  });

  initMap();
</script>
